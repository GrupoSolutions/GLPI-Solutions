{#
 # ---------------------------------------------------------------------
 #
 # GLPI - Gestionnaire Libre de Parc Informatique
 #
 # http://glpi-project.org
 #
 # @copyright 2015-2022 Teclib' and contributors.
 # @copyright 2003-2014 by the INDEPNET Development Team.
 # @licence   https://www.gnu.org/licenses/gpl-3.0.html
 #
 # ---------------------------------------------------------------------
 #
 # LICENSE
 #
 # This file is part of GLPI.
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 #
 # ---------------------------------------------------------------------
 #}

{% set target       = params['target'] ?? item.getFormURL() %}
{% set canedit      = params['canedit'] ?? true %}
{% set withtemplate = params['withtemplate'] ?? '' %}
{% set rand         = random() %}
{% set nametype     = params['formtitle'] ?? item.getTypeName(1) %}
{% set friendlyname = params['friendlyname'] ?? item.getHeaderName() %}
{% set no_id        = params['noid'] ?? false %}
{% set id           = item.fields['id'] ?? -1 %}
{% set formoptions  = params['formoptions'] ?? '' %}
{% set currentPath = app.request.attributes.get('_route_params') %}
{% set entity_id = 0 %}
{% set entity_name = '' %}
{% if item.isEntityAssign() %}
   {% if item.getType() == 'Entity' and item.fields['id'] == 0 %}
      {% set entity_id = null %}
   {% else %}
      {% set entity_id = params['entities_id'] ?? item.getEntityID() ?? session('glpiactive_entity') %}
   {% endif %}

   {% if is_multi_entities_mode() %}
      {% set entity_name = get_item_name('Entity', item.getEntityID()) %}
   {% endif %}
{% endif %}
{% if item.canEdit(item.fields['id']) %}
<form name="massaction_{{ rand }}" id="massaction_{{ rand }}" method="post"
      action="{{ path('/front/massiveaction.php') }}" data-submit-once>
   <div id="massive_container_{{ rand }}"></div>
   <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token() }}" />
</form>

{% if (nametype == 'Computador') or (nametype == 'Monitor') or (nametype == 'Impressora') or (nametype == 'Telefone') or (nametype == 'Dispositivo') or (nametype == 'Dispositivo de rede')  %}
   {% if not item.isNewItem %}
   
   <script src="/glpi108/assets/css/fa6.js"></script>
   <form method='post' name='useditemsexport_form$rand' id='useditemsexport_form$rand' action="{{ path('/marketplace/useditemsexport/inc/termounit.php') }}">
      <table class='row '>
      <tr class='row'>
         <td class="col" >
            <button type='submit' name='generate' class="btn btn-primary" style="display:inline-grid;">
               <i class="fa-sharp fa-solid fa-file-pdf fa-xl mt-3"></i>
               <span class="mt-3">Termo de Devolução</span>
            </button>
            <input type="hidden" name="entities_id" value="{{ id }}" />
            <input type="hidden" name="tipo" value="{{nametype}}"/>
         </td>
         <td class="col" >
            <button type='submit' name='generate' class="btn btn-primary" style="display:inline-grid;">
               <i class="fa-sharp fa-solid fa-file-circle-info fa-xl mt-3"></i>
               <span class="mt-3">Termo de Manutenção</span>
            </button>
            <input type="hidden" name="entities_id" value="{{ id }}" />
            <input type="hidden" name="acao" value="manutencao"/>
         </td>
      </tr>
   </table>
   </form>
   <form method='post' id="frmEtq" action="{{ path('/marketplace/useditemsexport/inc/aer.php') }}">
      <td class="col">
         <p> Gerar AR
         <input type='button' onclick="geraAr()" name='aer' value="Gerar" class='submit'>
         <div id="itensContainer">
            <input type="hidden" name="entities_id" value="{{ id }}" />
            <input type="hidden" id="user_id" name="user_id" value="{{ id }}" />
            <input type="hidden" id="nametype" name="nametype" value="{{ nametype }}" />

            <input type="hidden" name="acao" value="ar"/>
         </div>
      </td>
   </form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  .ende {
        text-align:initial;
        font-size:18px;
        width:100%;
    }
    .ende label {
        
        font-weight:500;
    }
</style>
   <script>
   var dadosArray = [];

   function inserirNovoItem() {
      
      if(!conteudo.value || !quantidade.value || !valor.value){
         console.warn("Erro, Campos nulos ou vazios");
         return "erro";
      }
      else {
         var novoItem = {
            conteudo: conteudo.value,
            quantidade: quantidade.value,
            valor: valor.value
         };
         dadosArray.push(novoItem);

         // Limpar os inputs após adicionar ao array
         document.getElementById('conteudo').value = '';
         document.getElementById('quantidade').value = '';
         document.getElementById('valor').value = '';

      
         var itensContainer = document.getElementById("itensContainer");

         // Preencha os campos de entrada ocultos com os valores dos arrays
         dadosArray.forEach(function(itemc, index) {
            var inputNome = document.createElement("input");
            inputNome.type = "hidden";
            inputNome.name = "itens[" + index + "][conteudo]";
            inputNome.value = itemc.conteudo;
            
            var inputQuantidade = document.createElement("input");
            inputQuantidade.type = "hidden";
            inputQuantidade.name = "itens[" + index + "][quantidade]";
            inputQuantidade.value = itemc.quantidade;
            
            var inputValor = document.createElement("input");
            inputValor.type = "hidden";
            inputValor.name = "itens[" + index + "][valor]";
            inputValor.value = itemc.valor;
            
            itensContainer.appendChild(inputNome);
            itensContainer.appendChild(inputQuantidade);
            itensContainer.appendChild(inputValor);
         });
      }
      
   }

   function geraAr(){
      //aqui tem que vir uma requisição ajax, buscando a localização do usuario, e em seguida exibindo no sweet alert,
      //A operação informada, vai ficar armazenada na session, após requerir a página em php para impressão, irá ser esvaziada
      const usuario_id = document.getElementById("user_id").value;
      const nametype = document.getElementById("nametype").value;
      $.ajax({
         type: "POST",
         data: {
            usuario_id: usuario_id,
            nametype: nametype,
         },
         url: "/glpi108/templates/components/ajax/buscaLocalizacao.php",
         success: function(response){
            var arrayRecebido = response;
            var rua = arrayRecebido[0];
            var bairro = arrayRecebido[1];
            var cep = arrayRecebido[2];
            var cidade = arrayRecebido[3];
            var estado = arrayRecebido[4];
            var numero = arrayRecebido[5];
            var complemento = arrayRecebido[6];
            var nome = arrayRecebido[7];
            var tipo = arrayRecebido[8];

            const { value: fruit } = Swal.fire({      
            title: 'Confirme os dados de entrega',
            html: '<p>Rua: ' + rua + '<br>Bairro: ' + bairro + '<br>CEP: ' + cep + '<br>Cidade: ' + cidade + '<br>Estado: ' + estado + '<br>Numero: ' + numero + '<br>Complemento: ' + complemento,
            input: 'select',
            inputOptions: {
               'whp': 'WHP',
               'rma': 'RMA',
               'triagem': 'TRIAGEM',
               'trirma': 'TRIAGEM/RMA'
            },
            inputPlaceholder: 'Informe a Operação',
            showCancelButton: true,
            inputValidator: (value) => {
               return new Promise((resolve) => {
                  if (!value) {
                  resolve('Informe uma operação.')
                  } else {
                     Swal.fire({
                        title: 'Será enviado outros itens na mesma embalagem?',
                        text: "Dados importantes para a declaração de conteúdo!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sim',
                        cancelButtonText: 'Não',
                        }).then((result) => {
                        if (result.isConfirmed) {
                           const { value: formValues } = Swal.fire({
                              title: 'Identificação dos Bens',
                              html:
                                 '<label for="conteudo" class="ende">Conteúdo:</label>' +
                                 '<input id="conteudo" class="ende" required>' +
                                 '<label for="quantidade" class="ende">Quantidade:</label>' +
                                 '<input id="quantidade"  class="ende" onkeypress="return somenteNumeros(event)" required>' +
                                 '<label for="valor" class="ende">Valor(R$):</label>' +
                                 '<input type="text" id="valor" oninput="formatarValor(this)" class="ende" required>' +
                                 '<button type="button" class="btn btn-success mt-2" onclick="inserirNovoItem()">Adicionar mais um item</button>',
                              focusConfirm: false,
                              showConfirmButton: true,
                              confirmButtonText: 'Finalizar',
                              preConfirm: () => {
                                 var conteudo = document.getElementById('conteudo').value;
                                 var quantidade = document.getElementById('quantidade').value;
                                 var vlr = document.getElementById('valor').value;
                                 var valor = vlr.toLocaleString('pt-BR', {
                                    style: 'currency',
                                    currency: 'BRL',
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                 });
                                 return [
                                   conteudo, quantidade, valor
                                 ]
                              }
                           }).then((result) => {
                              //Aqui ele deve verificar se há algum item preenchido antes de efetuar o envio para a página de impressão
                              if(result.isConfirmed){
                               if(!conteudo.value || !quantidade.value || !valor.value){
                                    imprimirAR();
                                 } else {
                                       inserirNovoItem();
                                       imprimirAR();
                                 }
                              
                              }
                           });
                        } else {
                           //Aqui deve mandar os unicos dados para busca do ativo, sem o array.
                           imprimirAR();
                        }
                     })
                  }
               })
            }
         })
         }

      });

   }

   // parâmetros da função moeda (pelo que entendi)
// a = objeto do input // e = separador milésimo
// r = separador decimal // t = evento
function imprimirAR(){
   let frmEtq = document.getElementById("frmEtq");
   frmEtq.submit();
}
function formatarValor(input) {
   const valorEntrada = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
   const valorNumerico = parseInt(valorEntrada) / 100; // Converte para número e divide por 100 para trazer os centavos

   input.value = valorNumerico.toLocaleString('pt-BR', {
         style: 'currency',
         currency: 'BRL',
         minimumFractionDigits: 2,
         maximumFractionDigits: 2
   });
}
function somenteNumeros(e) {
        var charCode = e.charCode ? e.charCode : e.keyCode;
        // charCode 8 = backspace   
        // charCode 9 = tab
        if (charCode != 8 && charCode != 9) {
            // charCode 48 equivale a 0   
            // charCode 57 equivale a 9
            if (charCode < 48 || charCode > 57) {
                return false;
            }
        }
    }
</script>
   </form>
   {% endif %}
   
{% endif %}


<form name="asset_form" method="post" action="{{ target }}" {{ formoptions|raw }} enctype="multipart/form-data" data-submit-once>
   <input type="hidden" name="entities_id" value="{{ entity_id }}" />

{% endif %}
   <div id="mainformtable">
      {% set template_name = item.fields['template_name']|verbatim_value %}
      {% if withtemplate == 2 and not item.isNewItem() %}
         <input type="hidden" name="template_name" value="{{ template_name }}" />
         {% set nametype = __('Created from the template %s')|format(template_name) %}
      {% elseif withtemplate == 1 %}
         <input type="hidden" name="is_template" value="1" />
      {% elseif item.isNewItem() %}
         {% set nametype = __('%1$s - %2$s')|format(__('New item'), nametype) %}
      {% else %}
         {% if noid == false and (session('glpiis_ids_visible') or nametype|length == 0) %}
            {% set nametype = __('%1$s - %2$s')|format(nametype, item.fields['id']) %}
         {% endif %}
      {% endif %}

      {% if no_header is not defined or no_header == false %}
         <div class="card-header main-header d-flex flex-wrap mx-n2 mt-n2 align-items-stretch">
            {% if withtemplate == 1 %}
               <input type="text" class="form-control ms-4 mb-2" placeholder="{{ __('Template name') }}"
                  name="template_name" id="textfield_template_name{{ rand }}"
                  value="{{ template_name }}" />
            {% endif %}
            <h3 class="card-title d-flex align-items-center ps-4">
               {% set icon = item.getIcon() %}
               {% if icon|length > 0 %}
                  <div class="ribbon ribbon-bookmark ribbon-top ribbon-start bg-blue s-1">
                     <i class="{{ icon }} fa-2x"></i>
                  </div>
               {% endif %}
               <span>
               {% if item.id > 0 %}
                  {{ nametype }} - {{  friendlyname }} 
               {% else %}
                  {{ nametype }}
               {% endif %}
               
               </span>
               
               {% if header_toolbar %}
                  <div class="d-inline-block toolbar ms-2">
                     {% for raw_element in header_toolbar %}
                        {{ raw_element|raw }}
                     {% endfor %}
                  </div>
               {% endif %}
            </h3>
            
            {% set single_actions_ms_auto = true %}
            
           
            {{ include('components/form/single-action.html.twig') }}
         </div>
      {% endif %}

      {{ call_plugin_hook(constant('Glpi\\Plugin\\Hooks::PRE_ITEM_FORM'), {'item': item, 'options': params}) }}

      {# todo modal message #}
      {% if app.request.request('in_modal') == true %}
      
      <input type="hidden" name="_no_message_link" value="1" />
      {% endif %}
